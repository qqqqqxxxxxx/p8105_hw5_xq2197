---
title: "Homework 5"
author: "Clare Qian"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(ggplot2)
library(rvest)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Problem 1

Read in the data.

```{r}
homicide_df =
  read_csv("homicide_data/homicide-data.csv") %>%
  mutate(
    city_state = str_c(city, state, sep = "_"),
    resolved = case_when(
      disposition == "Closed without arrest" ~ "unsolved",
      disposition == "Open/No arrest"        ~ "unsolved",
      disposition == "Closed by arrest"      ~ "solved"
    )
  ) %>%
  select(city_state, resolved) %>%
  filter(city_state != "Tulsa_AL")
```

Let's look at this a bit.

```{r}
aggregate_df =
  homicide_df %>%
  group_by(city_state) %>%
  summarize(
    hom_total = n(),
    hom_unsolved = sum(resolved == "unsolved")
  )
```

```{r}
prop.test(
  aggregate_df %>% filter(city_state == "Baltimore_MD") %>% pull(hom_unsolved),
  aggregate_df %>% filter(city_state == "Baltimore_MD") %>% pull(hom_total)) %>%
  broom::tidy()
```

Try to iterate.

```{r}
results_df = 
  aggregate_df %>%
  mutate(
    prop_tests = map2(.x = hom_unsolved, .y = hom_total, ~prop.test(x = .x, n = .y)),
    tidy_tests = map(.x = prop_tests, ~broom::tidy(.x))
  ) %>%
  select(-prop_tests) %>%
  unnest(tidy_tests) %>%
  select(city_state, estimate, conf.low, conf.high)
```

```{r}
results_df %>%
  mutate(city_state = fct_reorder(city_state, estimate)) %>%
  ggplot(aes(x = city_state, y = estimate)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

## Problem 2

Import the dataset.

```{r}
lda_df = 
  tibble(
    path = list.files("lda_data")
  ) %>%
  mutate(
    data = map(.x = str_c("lda_data/", path), ~read_csv(.x))
  ) %>%
  unnest(data) %>%
  mutate(
    path = substr(path, 0, 6),
    group = substr(path, 0, 3),
    sub_id = substr(path, 5, 6)) %>%
  select(path, group, sub_id, week_1:week_8) %>%
  pivot_longer(
    week_1:week_8,
    names_to = "week",
    values_to = "observation"
  ) %>%
  mutate(week = substr(week, 6, 7))
```

Create a spaghetti plot for each subject.

```{r}
lda_df %>%
  ggplot(aes(x = week, y = observation, group = path)) +
  geom_line(aes(color = group)) + 
  labs(
  title = "Longitudinal plot",
  x = "Week",
  y = "Observation",
  caption = "Data from the lda dataset"
  )
```

As observed in the plot, the observation values of subjects in the experimental group were higher than those of subjects in the control group. Additionally, the observation values of the experimental group continued increasing in the 8-week period, while the data of the control group were relatively stable during the 8-week period.

## Problem 3

Write the function that generate the normalization dataset and conduct the t-test.

```{r}
sim_mean_sd = function(n = 30, mu, sigma = 5) {
  sim_data = tibble(
    x = rnorm(n, mean = mu, sd = sigma)
  ) %>%
  t.test(alternative = "two.sided", mu = 0) %>%
  broom::tidy() %>%
  select(estimate, p.value)  
}
```

Write the simulation function.

```{r}
sim_results = function(x) { 
  rerun(5000, sim_mean_sd(mu = x)) %>% 
  bind_rows()
}
sim_results(0)
```

Map to all the values of mu.

```{r}
list_df = 
  tibble(mu = 0:6,
         t_test = map(.x = list_df$mu, ~sim_results(.x))
  )
```

Calculate the proportions and average estimate of each mu.

```{r}
summarize_fx = function(x){
  x %>%
    mutate(
      H0 = case_when(
        p.value < 0.05 ~ "rejected",
        p.value > 0.05 ~ "not rejected"
        )
    ) %>%
    summarize(
      null_reject = sum(H0 == "rejected"),
      prop = null_reject/5000,
      avg_est = mean(estimate)
  )
}
list_df =
  list_df %>%
  mutate(
    summarize_list = map(.x = list_df$t_test, ~summarize_fx(.x))
  ) %>%
  unnest(summarize_list)
```

Generate the first plot.

```{r}
list_df %>%
  ggplot(aes(x = mu, y = prop)) +
  geom_point() +
  geom_smooth(se = FALSE) +
  labs(
  title = "Mu and power plot",
  x = "True value of mu",
  y = "Power of test",
  caption = "Data from the summarize_df dataset"
  )
```

Description: When the effect size increase, the power of test increase, first fast and then slowly.

Generate the second plot.

```{r}
list_df %>%
  ggplot(aes(x = mu, y = avg_est)) +
  geom_point()
```

Generate the third plot.

```{r}
filter_fx = function(x){
   x %>%
    mutate(
      H0 = case_when(
        p.value < 0.05 ~ "rejected",
        p.value > 0.05 ~ "not rejected"
        )
    ) %>%
    filter(H0 == "rejected") %>%
    summarize(avg_est_fil = mean(estimate))
}

list_df %>%
  mutate(
    avg_list = map(.x = list_df$t_test, ~filter_fx(.x))
  ) %>%
  unnest(avg_list) %>%
  ggplot(aes(x = mu, y = avg_est_fil)) +
  geom_point()
```